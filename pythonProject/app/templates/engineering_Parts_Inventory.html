<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H+ 后台主题UI框架 - 零件管理</title>
    <meta name="keywords" content="H+后台主题,后台bootstrap框架,会员中心主题,后台HTML,响应式后台">
    <meta name="description" content="H+是一个完全响应式，基于Bootstrap3最新版本开发的扁平化主题，她采用了主流的左右两栏式布局，使用了Html5+CSS3等现代技术">
    <link rel="shortcut icon" href="favicon.ico">
    <link href="{{ url_for('static', filename='css/bootstrap.min14ed.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/font-awesome.min93e3.css') }}" rel="stylesheet">
    <!-- Data Tables -->
    <link href="{{ url_for('static', filename='css/plugins/dataTables/dataTables.bootstrap.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/animate.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.min862f.css') }}" rel="stylesheet">

</head>
<body class="gray-bg">
    <div class="wrapper wrapper-content animated fadeInRight">
        <div class="row">
            <div class="col-sm-12">
                <div class="ibox float-e-margins">
                    <div class="ibox-title">
                        <h5>零件管理</h5>
                        <div class="ibox-tools">
                            <a class="collapse-link">
                                <i class="fa fa-chevron-up"></i>
                            </a>
                        </div>
                    </div>
                    <div class="ibox-content">
                        <div class="">
                            <a onclick="showAddPartModal();" href="javascript:void(0);" class="btn btn-primary">添加零件</a>
                        </div>
                        <table class="table table-striped table-bordered table-hover dataTables-example" id="partTable">
                            <thead>
                                <tr>
                                    <th style="width: 80px;">零件編號</th>
                                    <th style="width: 200px;">名稱</th>
                                    <th style="width: 100px;">品牌</th>
                                    <th>用途</th>
                                    <th style="width: 80px;">操作</th>
                                </tr>
                            </thead>
                            <tbody id="parts-tbody">
                                <!-- 這裡的內容將由JavaScript動態生成 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-sm-12">
                <div class="ibox float-e-margins">
                    <div class="ibox-title">
                        <h5>倉庫管理</h5>
                        <div class="ibox-tools">
                            <a class="collapse-link">
                                <i class="fa fa-chevron-up"></i>
                            </a>
                        </div>
                    </div>
                    <div class="ibox-content">
                        <div class="">
                            <a onclick="showAddWarehouseModal();" href="javascript:void(0);" class="btn btn-primary">添加倉庫</a>
                        </div>
                        <table class="table table-striped table-bordered table-hover dataTables-example" id="warehouseTable">
                            <thead>
                                <tr>
                                    <th>倉庫名稱</th>
                                    <th>倉庫位置</th>
                                    <th>倉庫管理人</th>
                                    <th style="width: 100px;">操作</th>
                                </tr>
                            </thead>
                            <tbody id="warehouse-tbody">
                                <!-- 這裡的內容將由JavaScript動態生成 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- 添加零件模态框 -->
    <div class="modal fade" id="addPartModal" tabindex="-1" role="dialog" aria-labelledby="addPartModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title" id="addPartModalLabel">添加零件</h4>
                </div>
                <div class="modal-body">
                    <form id="addPartForm">
                        <div class="form-group">
                            <label for="partNumber">零件編號</label>
                            <input type="text" class="form-control" id="partNumber" name="partNumber" required>
                        </div>
                        <div class="form-group">
                            <label for="name">名稱</label>
                            <input type="text" class="form-control" id="name" name="name" required>
                        </div>
                        <div class="form-group">
                            <label for="brand">品牌</label>
                            <input type="text" class="form-control" id="brand" name="brand" required>
                        </div>
                        <div class="form-group">
                            <label for="usage">用途</label>
                            <input type="text" class="form-control" id="usage" name="usage" required>
                        </div>
                        <button type="submit" class="btn btn-primary">保存</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 编辑零件模态框 -->
    <div class="modal fade" id="editPartModal" tabindex="-1" role="dialog" aria-labelledby="editPartModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title" id="editPartModalLabel">编辑零件</h4>
                </div>
                <div class="modal-body">
                    <form id="editPartForm">
                        <div class="form-group">
                            <label for="editPartNumber">零件編號</label>
                            <input type="text" class="form-control" id="editPartNumber" name="editPartNumber" required>
                        </div>
                        <div class="form-group">
                            <label for="editName">名稱</label>
                            <input type="text" class="form-control" id="editName" name="editName" required>
                        </div>
                        <div class="form-group">
                            <label for="editBrand">品牌</label>
                            <input type="text" class="form-control" id="editBrand" name="editBrand" required>
                        </div>
                        <div class="form-group">
                            <label for="editUsage">用途</label>
                            <input type="text" class="form-control" id="editUsage" name="editUsage" required>
                        </div>
                        <input type="hidden" id="editPartId">
                        <button type="submit" class="btn btn-primary">保存</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加倉庫模态框 -->
    <div class="modal fade" id="addWarehouseModal" tabindex="-1" role="dialog" aria-labelledby="addWarehouseModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title" id="addWarehouseModalLabel">添加倉庫信息</h4>
                </div>
                <div class="modal-body">
                    <form id="addWarehouseForm">
                        <div class="form-group">
                            <label for="warehouseName">倉庫名稱</label>
                            <input type="text" class="form-control" id="warehouseName" name="warehouseName" required>
                        </div>
                        <div class="form-group">
                            <label for="location">倉庫位置</label>
                            <input type="text" class="form-control" id="location" name="location" required>
                        </div>
                        <div class="form-group">
                            <label for="principal">倉庫管理人</label>
                            <input type="text" class="form-control" id="principal" name="principal" required>
                        </div>
                        <button type="submit" class="btn btn-primary">保存</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 删除确认模态框 -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" role="dialog" aria-labelledby="deleteConfirmModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteConfirmModalLabel">删除確認</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="deleteConfirmForm">
                        <div class="form-group">
                            <label for="confirmPassword">請輸入密碼以確認删除操作</label>
                            <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" required>
                        </div>
                        <input type="hidden" id="deleteItemId">
                        <input type="hidden" id="deleteItemType">
                        <button type="submit" class="btn btn-danger">確認删除</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/jquery.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/bootstrap.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/plugins/dataTables/jquery.dataTables.js') }}"></script>
    <script src="{{ url_for('static', filename='js/plugins/dataTables/dataTables.bootstrap.js') }}"></script>
    <script src="{{ url_for('static', filename='js/content.min.js') }}"></script>
    <script src="https://cdn.datatables.net/plug-ins/1.10.21/i18n/Chinese-traditional.json"></script>
    <script>
        $(document).ready(function() {
            function loadParts() {
                console.log('Loading parts data...');
                $.get("/get_parts", function(data) {
                    console.log('Parts data received:', data);
                    var parts = data.parts;
                    var tbodyHtml = '';
                    for (var i = 0; i < parts.length; i++) {
                        tbodyHtml += '<tr class="gradeX">';
                        tbodyHtml += '<td>' + parts[i].part_number + '</td>';
                        tbodyHtml += '<td>' + parts[i].name + '</td>';
                        tbodyHtml += '<td>' + parts[i].brand + '</td>';
                        tbodyHtml += '<td>' + parts[i].usage + '</td>';
                        tbodyHtml += '<td>';
                        tbodyHtml += '<a href="javascript:void(0);" onclick="showEditPartModal(' + parts[i].id + ')">编辑</a> ';
                        tbodyHtml += '<a href="javascript:void(0);" onclick="showDeleteModal(' + parts[i].id + ', \'part\')">刪除</a>';
                        tbodyHtml += '</td>';
                        tbodyHtml += '</tr>';
                    }
                    if ($.fn.DataTable.isDataTable('#partTable')) {
                        var table = $('#partTable').DataTable();
                        table.clear().rows.add($(tbodyHtml)).draw();
                    } else {
                        $('#parts-tbody').html(tbodyHtml);
                        $('#partTable').DataTable({
                            language:{
                                "emptyTable": "無資料...",
                                "processing": "處理中...",
                                "loadingRecords": "載入中...",
                                "lengthMenu": "顯示 _MENU_ 項結果",
                                "zeroRecords": "沒有符合的結果",
                                "info": "顯示第 _START_ 至 _END_ 項結果，共 _TOTAL_ 項",
                                "infoEmpty": "顯示第 0 至 0 項結果，共 0 項",
                                "infoFiltered": "(從 _MAX_ 項結果中過濾)",
                                "infoPostFix": "",
                                "search": "搜尋:",
                                "paginate": {
                                    "first": "第一頁",
                                    "previous": "上一頁",
                                    "next": "下一頁",
                                    "last": "最後一頁"
                                },
                                "aria": {
                                    "sortAscending": ": 升冪排列",
                                    "sortDescending": ": 降冪排列"
                                }
                            }
                        });
                    }
                });
            }

            function loadWarehouses() {
                console.log('Loading warehouses data...');
                $.get("/get_warehouses", function(data) {
                    console.log('Warehouses data received:', data);
                    var warehouses = data.warehouses;
                    var tbodyHtml = '';
                    for (var i = 0; i < warehouses.length; i++) {
                        tbodyHtml += '<tr class="gradeX">';
                        tbodyHtml += '<td>' + warehouses[i].name + '</td>';
                        tbodyHtml += '<td>' + warehouses[i].location + '</td>';
                        tbodyHtml += '<td>' + warehouses[i].principal + '</td>';
                        tbodyHtml += '<td><a href="javascript:void(0);" onclick="showDeleteModal(' + warehouses[i].id + ', \'warehouse\')">刪除</a></td>';
                        tbodyHtml += '</tr>';
                    }
                    if ($.fn.DataTable.isDataTable('#warehouseTable')) {
                        var table = $('#warehouseTable').DataTable();
                        table.clear().rows.add($(tbodyHtml)).draw();
                    } else {
                        $('#warehouse-tbody').html(tbodyHtml);
                        $('#warehouseTable').DataTable({
                            language:{
                                "emptyTable": "無資料...",
                                "processing": "處理中...",
                                "loadingRecords": "載入中...",
                                "lengthMenu": "顯示 _MENU_ 項結果",
                                "zeroRecords": "沒有符合的結果",
                                "info": "顯示第 _START_ 至 _END_ 項結果，共 _TOTAL_ 項",
                                "infoEmpty": "顯示第 0 至 0 項結果，共 0 項",
                                "infoFiltered": "(從 _MAX_ 項結果中過濾)",
                                "infoPostFix": "",
                                "search": "搜尋:",
                                "paginate": {
                                    "first": "第一頁",
                                    "previous": "上一頁",
                                    "next": "下一頁",
                                    "last": "最後一頁"
                                },
                                "aria": {
                                    "sortAscending": ": 升冪排列",
                                    "sortDescending": ": 降冪排列"
                                }
                            }
                        });
                    }
                });
            }

            loadParts();
            loadWarehouses();

            window.showAddPartModal = function() {
                $('#addPartModal').modal('show');
            };

            window.showAddWarehouseModal = function() {
                $('#addWarehouseModal').modal('show');
            };

            window.showEditPartModal = function(id) {
                $.get("/get_partid/" + id, function(data) {
                    $('#editPartId').val(data.id);
                    $('#editPartNumber').val(data.part_number);
                    $('#editName').val(data.name);
                    $('#editBrand').val(data.brand);
                    $('#editUsage').val(data.usage);
                    $('#editPartModal').modal('show');
                });
            };

            $('#addPartForm').submit(function(e) {
                e.preventDefault();
                var partData = {
                    part_number: $('#partNumber').val(),
                    name: $('#name').val(),
                    brand: $('#brand').val(),
                    usage: $('#usage').val()
                };
                $.ajax({
                    type: "POST",
                    url: "/add_part",
                    contentType: "application/json",
                    data: JSON.stringify(partData),
                    success: function(response) {
                        $('#addPartModal').modal('hide');
                        loadParts();
                    },
                    error: function(xhr, status, error) {
                        if (xhr.status === 400 && xhr.responseJSON.error === 'parts.part_number') {
                            alert('錯誤！有相同編號');
                        } else {
                            alert('添加失敗');
                        }
                    }
                });
            });

            $('#addWarehouseForm').submit(function(e) {
                e.preventDefault();
                var warehouseData = {
                    name: $('#warehouseName').val(),
                    location: $('#location').val(),
                    principal: $('#principal').val()
                };
                $.ajax({
                    type: "POST",
                    url: "/add_warehouse",
                    contentType: "application/json",
                    data: JSON.stringify(warehouseData),
                    success: function(response) {
                        $('#addWarehouseModal').modal('hide');
                        loadWarehouses();
                    },
                    error: function(error) {
                        alert('添加失敗');
                    }
                });
            });

            window.showDeleteModal = function(id, type) {
                $('#deleteItemId').val(id);
                $('#deleteItemType').val(type);
                $('#deleteConfirmModal').modal('show');
            };

            $('#deleteConfirmForm').submit(function(e) {
                e.preventDefault();
                var id = $('#deleteItemId').val();
                var type = $('#deleteItemType').val();
                var password = $('#confirmPassword').val();

                $.ajax({
                    type: "POST",
                    url: type === 'part' ? "/delete_part" : "/delete_warehouse",
                    contentType: "application/json",
                    data: JSON.stringify({ id: id, password: password }),
                    success: function(response) {
                        $('#deleteConfirmModal').modal('hide');
                        if (type === 'part') {
                            loadParts();
                        } else {
                            loadWarehouses();
                        }
                    },
                    error: function(xhr, status, error) {
                        alert('刪除失敗');
                    }
                });
            });
            $('#editPartForm').submit(function(e) {
                e.preventDefault();
                var partData = {
                    id: $('#editPartId').val(),
                    part_number: $('#editPartNumber').val(),
                    name: $('#editName').val(),
                    brand: $('#editBrand').val(),
                    usage: $('#editUsage').val()
                };

                console.log('Sending data:', partData); // 记录发送的数据

                $.ajax({
                    type: "POST",
                    url: "/edit_part",
                    contentType: "application/json",
                    data: JSON.stringify(partData),
                    success: function(response) {
                        $('#editPartModal').modal('hide');
                        loadParts();
                    },
                    error: function(error) {
                        alert('编辑失败');
                    }
                });
            });
        });
    </script>
</body>
</html>
